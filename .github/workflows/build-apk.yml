name: Build APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps
      
      - name: Install Expo CLI
        run: npm install -g expo-cli@6.3.10
      
      - name: Remove icon
        run: rm -f icon.jpg
      
      - name: Prebuild
        run: npx expo prebuild --platform android --clean
      
      - name: Fix android/build.gradle
        run: |
          cat > android/build.gradle << 'EOF'
          buildscript {
              ext {
                  buildToolsVersion = "33.0.0"
                  minSdkVersion = 21
                  compileSdkVersion = 33
                  targetSdkVersion = 33
                  ndkVersion = "23.1.7779620"
                  frescoVersion = "2.5.0"
                  kotlinVersion = "1.8.0"
              }
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath("com.android.tools.build:gradle:7.4.2")
                  classpath("com.facebook.react:react-native-gradle-plugin")
                  classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
              }
          }

          allprojects {
              repositories {
                  maven { url "$rootDir/../node_modules/expo-camera/android/maven" }
                  google()
                  mavenCentral()
              }
          }
          EOF
      
      - name: Fix expo-notifications
        run: |
          if [ -f "node_modules/expo-notifications/android/build.gradle" ]; then
            sed -i 's/classifier = /archiveClassifier = /g' node_modules/expo-notifications/android/build.gradle
          fi
      
      - name: Add gradle properties
        run: |
          cat >> android/gradle.properties << 'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=512m
          org.gradle.daemon=false
          EOF
      
      - name: Build APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon --stacktrace
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: steady-watch-apk
          path: android/app/build/outputs/apk/release/*.apk
